<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMADCIN - Relatório</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --azul: #1a3a5a; }
        body { font-family: sans-serif; background: #f4f7f6; padding: 10px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; border-top: 8px solid var(--azul); }
        canvas { width: 100%; height: 150px; border: 1px dashed #ccc; background: white; }
        .timestamp { font-size: 10px; color: #d9534f; font-weight: bold; margin-top: 5px; }
        .btn-gerar { background: #28a745; color: white; border: none; width: 100%; padding: 15px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #view-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: var(--azul); color:white; flex-direction:column; align-items:center; justify-content:center; z-index:99; }
    </style>
</head>
<body>

<div id="view-overlay"><h2>UMADCIN</h2><p>Gerando PDF oficial...</p></div>

<div class="container" id="main-content">
    <h2 style="text-align:center; color:var(--azul);">UMADCIN - RELATÓRIO</h2>
    <div style="display:grid; gap:10px; margin-bottom:20px;">
        <input type="date" id="data_form">
        <input type="text" id="congregacao" placeholder="Congregação">
        <input type="text" id="mes" placeholder="Mês Referência">
    </div>

    <table id="tabela" style="width:100%; border-collapse:collapse; margin-bottom:20px;"></table>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
        <div style="text-align:center;">
            <label>SEC. LOCAL</label><canvas id="pad-sec"></canvas>
            <div id="ts-sec" class="timestamp"></div>
        </div>
        <div style="text-align:center;">
            <label>ASSISTENTE</label><canvas id="pad-ast"></canvas>
            <div id="ts-ast" class="timestamp"></div>
        </div>
        <div style="text-align:center;">
            <label>DIRIGENTE</label><canvas id="pad-dir"></canvas>
            <div id="ts-dir" class="timestamp"></div>
        </div>
    </div>
    <button class="btn-gerar" onclick="finalizarTudo()">GERAR E ENVIAR</button>
</div>

<script>
    const labels = ["DECISÕES", "RECONCILIAÇÕES", "CULTOS DE RUA", "COJ", "VISITA", "BATISMO", "EBD", "TRAB. LOCAL", "JOVENS"];
    const pads = { sec: new SignaturePad(document.getElementById('pad-sec')), ast: new SignaturePad(document.getElementById('pad-ast')), dir: new SignaturePad(document.getElementById('pad-dir')) };
    
    labels.forEach((l, i) => {
        document.getElementById('tabela').innerHTML += `<tr><td style="padding:5px; border-bottom:1px solid #eee">${l}</td><td><input type="number" id="d${i}" value="0" style="width:50px"></td></tr>`;
    });

    function registrarHora(id) {
        document.getElementById('ts-' + id).innerText = "Assinado em: " + new Date().toLocaleString('pt-BR');
    }
    ['sec', 'ast', 'dir'].forEach(id => {
        document.getElementById('pad-'+id).addEventListener('touchend', () => registrarHora(id));
        document.getElementById('pad-'+id).addEventListener('mouseup', () => registrarHora(id));
    });

    async function criarPDF(dados) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16); doc.text("UMADCIN - RELATÓRIO MENSAL", 105, 20, {align:"center"});
        doc.setFontSize(10); doc.text(`CONGREGAÇÃO: ${dados.cong.toUpperCase()}`, 20, 35);
        doc.text(`MÊS: ${dados.mes.toUpperCase()}`, 20, 42);
        
        let y = 60;
        labels.forEach((l, i) => {
            doc.text(l, 25, y); doc.text(String(dados.vals[i]), 170, y);
            doc.line(20, y+2, 190, y+2); y += 10;
        });

        // Adiciona assinaturas e as datas (identificações)
        const xPos = [20, 85, 150];
        const tags = ["SEC. LOCAL", "ASSISTENTE", "DIRIGENTE"];
        const times = [dados.tSec, dados.tAst, dados.tDir];
        const imgs = [dados.imgSec, dados.imgAst, dados.imgDir];

        for(let i=0; i<3; i++) {
            if(imgs[i] && imgs[i].startsWith("http")) {
                try {
                    const img = await new Promise((res, rej) => {
                        const im = new Image(); im.crossOrigin="anonymous"; im.onload=()=>res(im); im.onerror=rej; im.src=imgs[i];
                    });
                    doc.addImage(img, 'PNG', xPos[i], 210, 40, 15);
                } catch(e) {}
            } else if (imgs[i] && imgs[i].startsWith("data:")) {
                doc.addImage(imgs[i], 'PNG', xPos[i], 210, 40, 15);
            }
            doc.setFontSize(8);
            doc.text(tags[i], xPos[i]+20, 230, {align:"center"});
            doc.text(times[i] || "", xPos[i]+20, 235, {align:"center"});
        }
        return doc;
    }

    async function finalizarTudo() {
        const dados = {
            cong: document.getElementById('congregacao').value,
            mes: document.getElementById('mes').value,
            vals: labels.map((_, i) => document.getElementById('d'+i).value),
            tSec: document.getElementById('ts-sec').innerText,
            tAst: document.getElementById('ts-ast').innerText,
            tDir: document.getElementById('ts-dir').innerText,
            imgSec: pads.sec.isEmpty() ? "" : pads.sec.toDataURL(),
            imgAst: pads.ast.isEmpty() ? "" : pads.ast.toDataURL(),
            imgDir: pads.dir.isEmpty() ? "" : pads.dir.toDataURL()
        };
        const doc = await criarPDF(dados);
        doc.save("Relatorio.pdf");
        
        fetch("https://script.google.com/macros/s/AKfycbyzp-Ycu3w3WiwBMMH72aHvFybxIMiYpAs644rwj-wB2Ayps7wvMA5woZxCV4RDscpG/exec", {
            method: 'POST', mode: 'no-cors', body: JSON.stringify({
                dataEnvio: document.getElementById('data_form').value,
                cong: dados.cong, mes: dados.mes, valores: dados.vals,
                times: {sec: dados.tSec, ast: dados.tAst, dir: dados.tDir},
                sigs: {sec: dados.imgSec, ast: dados.imgAst, dir: dados.imgDir}
            })
        });
        alert("Enviado com sucesso!");
    }

    window.onload = async () => {
        const p = new URLSearchParams(window.location.search);
        if(p.has('view')) {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('view-overlay').style.display = 'flex';
            const doc = await criarPDF({
                cong: p.get('cong'), mes: p.get('mes'), vals: p.get('vals').split(','),
                tSec: p.get('tSec'), tAst: p.get('tAst'), tDir: p.get('tDir'),
                imgSec: p.get('imgSec'), imgAst: p.get('imgAst'), imgDir: p.get('imgDir')
            });
            doc.save("Relatorio_Oficial.pdf");
        }
    };
</script>
</body>
</html>
